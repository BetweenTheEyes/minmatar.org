---
import { getLangFromUrl, useTranslations, useTranslatedPath } from '@i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

import * as jose from 'jose'

if (Astro.request.method !== "GET") Astro.redirect(translatePath('/'))

let error = null
let token = null
let claims = null
try {
    token = Astro.url.searchParams.get('token')
    claims = jose.decodeJwt(token)
} catch (error) {
    console.error('Error during token exchange:', error.message);
    error = error.message
}

const in_6_days = new Date(new Date().getTime()+(6*24*60*60*1000))
Astro.cookies.set('auth_token', token, { path: '/', expires: in_6_days })
Astro.cookies.set('avatar', claims.avatar, { path: '/', expires: in_6_days })

return Astro.redirect(translatePath('/account/'))
---